@model InventoryManagement.WebApp.Models.Orders.CreateOrderViewModel

@{
    ViewData["Title"] = "Create Order";
}

<h1>Create New Order</h1>

<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" id="orderForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Customer Information</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="CustomerName" class="control-label">Customer Name</label>
                        <input asp-for="CustomerName" class="form-control" />
                        <span asp-validation-for="CustomerName" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="CustomerEmail" class="control-label">Customer Email</label>
                        <input asp-for="CustomerEmail" class="form-control" type="email" />
                        <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="ShippingAddress" class="control-label">Shipping Address</label>
                        <textarea asp-for="ShippingAddress" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="ShippingAddress" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Notes" class="control-label">Order Notes (Optional)</label>
                        <textarea asp-for="Notes" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Order Items</h5>
                    <button type="button" class="btn btn-light btn-sm" id="addItemBtn">Add Item</button>
                </div>
                <div class="card-body">
                    <div id="orderItems">
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <div class="order-item mb-3 p-3 border rounded">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label asp-for="Items[i].ProductId" class="control-label">Product</label>
                                        <select asp-for="Items[i].ProductId" class="form-control product-select" asp-items="ViewBag.Products">
                                            <option value="">-- Select Product --</option>
                                        </select>
                                        <span asp-validation-for="Items[i].ProductId" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-5 mb-2">
                                        <label asp-for="Items[i].Quantity" class="control-label">Quantity</label>
                                        <input asp-for="Items[i].Quantity" class="form-control" type="number" min="1" value="1" />
                                        <span asp-validation-for="Items[i].Quantity" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end mb-2">
                                        <button type="button" class="btn btn-outline-danger remove-item">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div id="item-template" class="d-none">
                        <div class="order-item mb-3 p-3 border rounded">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="control-label">Product</label>
                                    <select class="form-control product-select" name="Items[0].ProductId" asp-items="ViewBag.Products">
                                        <option value="">-- Select Product --</option>
                                    </select>
                                    <span class="text-danger"></span>
                                </div>
                                <div class="col-md-5 mb-2">
                                    <label class="control-label">Quantity</label>
                                    <input class="form-control" type="number" min="1" value="1" name="Items[0].Quantity" />
                                    <span class="text-danger"></span>
                                </div>
                                <div class="col-md-1 d-flex align-items-end mb-2">
                                    <button type="button" class="btn btn-outline-danger remove-item">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <input type="submit" value="Create Order" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Back to Orders</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            // Add item button click
            $("#addItemBtn").click(function() {
                var itemTemplate = $("#item-template").html();
                var itemCount = $(".order-item").length;

                // Update indices
                itemTemplate = itemTemplate.replace(/Items\[0\]/g, "Items[" + itemCount + "]");

                $("#orderItems").append(itemTemplate);

                // Re-attach event handlers
                attachRemoveHandlers();
            });

            // Function to handle removal
            function attachRemoveHandlers() {
                $(".remove-item").off("click").on("click", function() {
                    $(this).closest(".order-item").remove();
                    // Reindex items
                    $(".order-item").each(function(index) {
                        $(this).find("select, input").each(function() {
                            var name = $(this).attr("name");
                            if (name) {
                                var newName = name.replace(/Items\[\d+\]/g, "Items[" + index + "]");
                                $(this).attr("name", newName);
                            }
                        });
                    });
                });
            }

            // Initial attachment
            attachRemoveHandlers();
        });
    </script>
}